# Adapted from https://github.com/pandas-dev/pandas/blob/master/azure-pipelines.yml
schedules:
- cron: "30 2 * * *"
  displayName: Run nightly build
  branches:
    include:
    - main
  always: true

jobs:
- job: git_commit
  displayName: Get Git Commit
  pool:
    vmImage: ubuntu-20.04
  steps:
    - bash: python build_tools/azure/get_commit_message.py
      name: commit
      displayName: Get source version message

- job: linting
  dependsOn: [git_commit]
  condition: |
    and(
      succeeded(),
      not(contains(dependencies['git_commit']['outputs']['commit.message'], '[lint skip]')),
      not(contains(dependencies['git_commit']['outputs']['commit.message'], '[ci skip]'))
    )
  displayName: Linting
  pool:
    vmImage: ubuntu-20.04
  steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.9'
    - bash: |
        # Include pytest compatibility with mypy
        pip install pytest flake8 mypy==0.961 black==22.3.0
      displayName: Install linters
    - bash: |
        black --check --diff .
      displayName: Run black
    - bash: |
        ./build_tools/azure/linting.sh
      displayName: Run linting
    - bash: |
        mypy sklearn/
      displayName: Run mypy

- template: build_tools/azure/windows.yml
  parameters:
    name: Windows
    vmImage: windows-latest
    dependsOn: [linting, git_commit]
    condition: |
      and(
        succeeded(),
        not(contains(dependencies['git_commit']['outputs']['commit.message'], '[ci skip]'))
      )
    matrix:
      py38_conda_forge_mkl:
        DISTRIB: 'conda'
        LOCK_FILE: ./build_tools/azure/py38_conda_forge_mkl_win-64_conda.lock
        CHECK_WARNINGS: 'true'
        COVERAGE: 'true'
        SKLEARN_TESTS_GLOBAL_RANDOM_SEED: '7'  # non-default seed
      py38_pip_openblas_32bit:
        DISTRIB: 'pip-windows'
        PYTHON_VERSION: '3.8'
        PYTHON_ARCH: '32'
        LOCK_FILE: ./build_tools/azure/py38_pip_openblas_32bit_lock.txt
        SKLEARN_TESTS_GLOBAL_RANDOM_SEED: '8'  # non-default seed
