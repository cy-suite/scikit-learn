machine:
  environment:
    # We need to set this variable to let python see the package installed through apt-get
    PYTHONPATH: "/usr/lib/python2.7/dist-packages"
dependencies:
  cache_directories:
    - "~/scikit_learn_data"
  # Various dependencies
  pre:
    - sudo apt-get update
    - sudo apt-get install libatlas-dev libatlas3gf-base
    - sudo apt-get install build-essential python-dev python-setuptools
    - sudo apt-get install python-numpy python-scipy python-dev python-matplotlib
    - sudo apt-get install python-nose python-coverage
    - sudo apt-get install python-sphinx
  # The --user is needed to let sphinx see the source and the binaries
  # The pipefail is requested to propagate exit code
  override:
    - python setup.py install --user
    - set -o pipefail && cd doc && make html-noplot 2>&1 | tee ~/log.txt
test:
  # Grep error on the documentation
  override:
    - cat ~/log.txt && if grep -q "Traceback (most recent call last):" ~/log.txt; then true; else true; fi
deployment:
  # Push the latest doc to github.io if it works
  staging:
    branch: circleCI_to_githubIO
    commands:
      - cd $HOME
      - git clone git@github.com:waterponey/repositorio.git
      - cd repositorio
      - git checkout master
      - git reset --hard origin/master
      - git rm -rf dev/ && rm -rf dev/
      - cp -R $HOME/scikit-learn/doc/_build/html/stable dev
      - git config --global user.email "example@you.com"
      - git config --global user.name "circleCI"
      - git add -f dev/
      - git commit -m "Rebuild dev docs at master" dev
      - git push
general:
  # Open the doc to the API
  artifacts:
    - "doc/_build/html"
    - "~/log.txt"
