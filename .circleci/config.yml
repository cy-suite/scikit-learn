version: 2.1

jobs:
  lint:
    docker:
      - image: circleci/python:3.7
    steps:
      - checkout
      - run: ./build_tools/circle/checkout_merge_commit.sh
      - run:
          name: dependencies
          command: sudo pip install flake8
      - run:
          name: linting
          command: ./build_tools/circle/linting.sh

  linux-arm64:
    machine:
      image: ubuntu-2004:202101-01
    resource_class: arm.medium
    environment:
      - OMP_NUM_THREADS: 2
      - OPENBLAS_NUM_THREADS: 2
      - CYTHON_VERSION: 'latest'
      - JOBLIB_VERSION: 'latest'
      - THREADPOOLCTL_VERSION: 'latest'
      - PYTEST_VERSION: 'latest'
      - PYTEST_XDIST_VERSION: 'latest'
      - TEST_DOCSTRINGS: 'true'
    steps:
      - checkout
      - run: ./build_tools/circle/checkout_merge_commit.sh
      - restore_cache:
          key: v1-datasets-{{ .Branch }}
      - run: ./build_tools/circle/build_test_arm.sh
      - save_cache:
          key: doc-ccache-{{ .Branch }}-{{ .BuildNum }}
          paths:
            - ~/.ccache
            - ~/.cache/pip
      - save_cache:
          key: v1-datasets-{{ .Branch }}
          paths:
            - ~/scikit_learn_data

workflows:
  version: 2
  lint:
    jobs:
      - lint
  linux-arm64:
    jobs:
      - linux-arm64
